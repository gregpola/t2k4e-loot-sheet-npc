{"name":"loot-back-to-token","type":"script","author":"Trazzm","img":"icons/svg/dice-target.svg","scope":"global","command":"// Change selected tokens' sheets back to default.\n\nasync function main() {\n  for (let token of canvas.tokens.controlled) {\n    await token.document.actor.setFlag('core', 'sheetClass', 'Default');\n    await token.document.update({\n      'actorData.permission.default': CONST.ENTITY_PERMISSIONS.NONE,\n      overlayEffect: '',\n    });\n  }\n}\nmain();","folder":null,"sort":0,"permission":{"default":0,"xrutfo08ZKgCmTKc":3},"flags":{"core":{"sourceId":"Macro.Gxq9IhGfHa8M8kiC"}},"_id":"feDOmNZUcwZNOs26"}
{"name":"convert-to-lootable","type":"script","author":"Trazzm","img":"icons/svg/dice-target.svg","scope":"global","command":"/ For all currently selected tokens, changes their actor sheet to LootSheetNPC,\n// deletes all non-lootable items, sets token Observer privs for players, and adds a treasure\n// overlay icon to the body. Asks for confirmation because of the deletions.\n//\n// Original script by tas (ygg#0922) -- thanks tas!\n// Evolved with help from a ton of people, notably: @Akaito, @honeybadger, @kekilla, and @cole\n\nlet d = new Dialog({\n  title: 'Convert to lootable body',\n  content: `Sure? This will delete any non-lootable features.`,\n  buttons: {\n    no: {\n      icon: '<i class=\"fas fa-ban\"></i>',\n      label: 'Cancel',\n    },\n    yes: {\n      icon: '<i class=\"fas fa-thumbs-up\"></i>',\n      label: 'Convert',\n      callback: (html) => {\n        ConvertToLootable();\n      },\n    },\n  },\n  default: 'no',\n}).render(true);\n\nasync function ConvertToLootable() {\n  for (let token of canvas.tokens.controlled) {\n    // Don't run this on PC tokens by mistake\n    if (token.actor.data.type === 'character') continue;\n\n    // Remove items that shouldn't be lootable\n    let itemsToDelete = token.actor.items\n      .filter((item) => {\n        // Weapons are fine, unless they're natural.\n        if (item.type == 'weapon') {\n          return item.data.data.weaponType == 'natural';\n        }\n        // Equipment's fine, unless it's natural armor.\n        if (item.type == 'equipment') {\n          return item.data.data.armor.type == 'natural';\n        }\n        // Item type blocklist.\n        return ['class', 'spell', 'feat'].includes(item.type);\n      })\n      .map((item) => item.id);\n\n    await token.document.actor.deleteEmbeddedDocuments('Item', itemsToDelete);\n\n    // Change sheet to lootable, and give players permissions.\n    let newActorData = {\n      flags: {\n        core: {\n          sheetClass: 'dnd5e.LootSheetNPC5e',\n        },\n        lootsheetnpc5e: {\n          lootsheettype: 'Loot',\n        },\n      },\n    };\n\n    let lootingUsers = game.users\n      // Limit selection to Players and Trusted Players\n      .filter((user) => {\n        return user.role >= 1 && user.role <= 2;\n      });\n\n    // This section is a workaround for the fact that the LootSheetNPC module\n    // currently uses an older currency schema, compared to current 5e expectations.\n    // Need to convert the actor's currency data to the LS schema here to avoid\n    // breakage. If there is already currency on the actor, it is retained.\n\n    if (typeof token.actor.data.data.currency.cp === 'number') {\n      let oldCurrencyData = token.actor.data.data.currency;\n      newActorData['data.currency'] = {\n        cp: { value: oldCurrencyData.cp },\n        ep: { value: oldCurrencyData.ep },\n        gp: { value: oldCurrencyData.gp },\n        pp: { value: oldCurrencyData.pp },\n        sp: { value: oldCurrencyData.sp },\n      };\n    }\n\n    await token.document.actor.update(newActorData);\n\n    // Update permissions to level 2, so players can loot\n    let permissions = {};\n    Object.assign(permissions, token.actor.data.permission);\n    lootingUsers.forEach((user) => {\n      permissions[user.data._id] = 2;\n    });\n\n    // If using Combat Utility Belt, need to remove any of its condition overlays\n    // before we can add the chest icon overlay.\n    if (game.modules.get('combat-utility-belt')?.active) {\n      await game.cub.removeAllConditions(token);\n    }\n\n    await token.document.update({\n      overlayEffect: 'icons/svg/chest.svg',\n      actorData: {\n        actor: {\n          flags: {\n            loot: {\n              playersPermission: 2,\n            },\n          },\n        },\n        permission: permissions,\n      },\n    });\n  }\n}","folder":null,"sort":0,"permission":{"default":0,"xrutfo08ZKgCmTKc":3},"flags":{"core":{"sourceId":"Macro.ityrIpzfvN6NjdDW"}},"_id":"lzxGnGp88uFnbUNL"}
{"name":"tokens-to-loot","type":"script","author":"Trazzm","img":"icons/svg/dice-target.svg","scope":"global","command":"// Change selected tokens' sheets to LootSheets, but don't change anything else.\n\nasync function main() {\n  for (let token of canvas.tokens.controlled) {\n    await token.document.actor.setFlag('core', 'sheetClass', 'T2K4E.LootSheet');\n  }\n}\nmain();","folder":null,"sort":0,"permission":{"default":0,"xrutfo08ZKgCmTKc":3},"flags":{"core":{"sourceId":"Macro.DaD8fXuovpqRdnGN"}},"_id":"xy8Pb5Ab3ttrDAAv"}
